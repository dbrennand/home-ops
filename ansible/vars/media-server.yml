---
# vars file for media-playbook.yml
# dbrennand.caddy_docker role vars
# https://github.com/dbrennand/ansible-role-caddy-docker
caddy_docker_caddyfile: |-
  {
    email {$ACME_EMAIL}
  }

  (cloudflare) {
    tls {
      dns cloudflare {$CLOUDFLARE_API_TOKEN}
    }
  }

  # OpenMediaVault
  media01.{$DOMAIN} {
    import cloudflare
    reverse_proxy host.docker.internal:1080
  }
caddy_docker_image: ghcr.io/dbrennand/caddy-docker-proxy-cloudflare:2025.04.01
caddy_docker_command: caddy docker-proxy
caddy_docker_etc_hosts:
  host.docker.internal: host-gateway
caddy_docker_extra_volumes:
  # Required for Caddy to read Docker container labels
  - /var/run/docker.sock:/var/run/docker.sock
caddy_docker_environment_variables:
  # Variables used in the Caddyfile
  # https://github.com/lucaslorentz/caddy-docker-proxy#caddy-cli
  CADDY_INGRESS_NETWORKS: caddy
  CADDY_DOCKER_CADDYFILE_PATH: /etc/caddy/Caddyfile
  # Values come from group_vars/all.yml
  DOMAIN: "{{ domain }}"
  CLOUDFLARE_API_TOKEN: "{{ cloudflare_api_token }}"
  ACME_EMAIL: "{{ acme_email }}"

# dbrennand.autorestic role vars
# https://github.com/dbrennand/ansible-role-autorestic?tab=readme-ov-file#role-variables
autorestic_version: 1.8.3
autorestic_restic_version: 0.17.3
autorestic_config:
  version: 2

  global:
    all:
      verbose: true
    unlock:
      cleanup-cache: true
    forget:
      # Keep 2 weeks worth of snapshots
      keep-last: 14

  locations:
    paperless-ngx-export:
      from: /srv/dev-disk-by-uuid-bb90bdb7-731a-49ce-95e8-7034130bd751/apps/paperless-ngx/export
      to: backblaze
      hooks:
        prevalidate:
          - "docker exec paperless_ngx document_exporter /usr/src/paperless/export --zip"
        failure:
          - 'curl -X POST -H "Content-Type: application/json" -d "{\"content\": \":x: Backup failed for location: ${AUTORESTIC_LOCATION}\"}" "{{ discord_webhook }}"' # noqa yaml[line-length]
        after:
          # Find zip files older than 11 days and delete them
          - 'find /srv/dev-disk-by-uuid-bb90bdb7-731a-49ce-95e8-7034130bd751/apps/paperless-ngx/export -type f -name "*.zip" -mtime +11 -exec rm {} \;'
      cron: "0 23 * * *"
      forget: prune
  backends:
    backblaze:
      type: b2
      # Name of the B2 bucket
      path: dabpaperless
      # Key used by restic to encrypt backups
      key: "{{ lookup('community.general.onepassword', 'Backblaze', section='dabpaperless', field='RESTIC_REPOSITORY_PASSWORD', vault='Home-Ops') }}"
      # Backblaze B2 application ID and key
      env:
        B2_ACCOUNT_ID: "{{ lookup('community.general.onepassword', 'Backblaze', section='dabpaperless', field='B2_ACCOUNT_ID', vault='Home-Ops') }}"
        B2_ACCOUNT_KEY: "{{ lookup('community.general.onepassword', 'Backblaze', section='dabpaperless', field='B2_ACCOUNT_KEY', vault='Home-Ops') }}"
autorestic_cron: true
autorestic_cron_verbose: true
