---
# vars file for media-playbook.yml
# dbrennand.caddy_docker role vars
# https://github.com/dbrennand/ansible-role-caddy-docker
caddy_docker_caddyfile: |-
  {
    email {$ACME_EMAIL}
  }

  # Cloudflare DNS-01 challenge
  (cloudflare) {
    tls {
      dns cloudflare {$CLOUDFLARE_API_TOKEN}
    }
  }

  # OpenMediaVault
  media01.{$DOMAIN} {
    import cloudflare
    reverse_proxy host.docker.internal:1080
  }
caddy_docker_image: caddy:2.8.4-alpine
caddy_docker_builder_image: caddy:2.8.4-builder
caddy_docker_plugins:
  # Allows Caddy to obtain TLS certificates for a Cloudflare managed domain
  - github.com/caddy-dns/cloudflare@89f16b9
  # Allows Caddy site config to be applied via Docker container labels
  - github.com/lucaslorentz/caddy-docker-proxy/v2@v2.9.1
caddy_docker_command: caddy docker-proxy
caddy_docker_etc_hosts:
  host.docker.internal: host-gateway
caddy_docker_extra_volumes:
  # Required for Caddy to read Docker container labels
  - /var/run/docker.sock:/var/run/docker.sock
caddy_docker_environment_variables:
  # Variables used in the Caddyfile
  # https://github.com/lucaslorentz/caddy-docker-proxy#caddy-cli
  CADDY_INGRESS_NETWORKS: caddy
  CADDY_DOCKER_CADDYFILE_PATH: /etc/caddy/Caddyfile
  # Values come from group_vars/all.yml
  DOMAIN: "{{ domain }}"
  CLOUDFLARE_API_TOKEN: "{{ cloudflare_api_token }}"
  ACME_EMAIL: "{{ acme_email }}"

# dbrennand.autorestic role vars
# https://github.com/dbrennand/ansible-role-autorestic?tab=readme-ov-file#role-variables
autorestic_version: 1.8.3
autorestic_restic_version: 0.17.3
autorestic_config:
  version: 2

  global:
    all:
      verbose: true
    unlock:
      cleanup-cache: true
    forget:
      # Keep 2 weeks worth of snapshots
      keep-last: 14

  locations:
    paperless-ngx-export:
      from: /srv/dev-disk-by-uuid-bb90bdb7-731a-49ce-95e8-7034130bd751/apps/paperless-ngx/export
      to: backblaze
      hooks:
        prevalidate:
          - "docker exec paperless_ngx document_exporter /usr/src/paperless/export --zip"
        failure:
          - 'curl -X POST -H "Content-Type: application/json" -d "{\"content\": \":x: Backup failed for location: ${AUTORESTIC_LOCATION}\"}" "{{ discord_webhook }}"'
        after:
          # Find zip files older than 11 days and delete them
          - 'find /srv/dev-disk-by-uuid-bb90bdb7-731a-49ce-95e8-7034130bd751/apps/paperless-ngx/export -type f -name "*.zip" -mtime +11 -exec rm {} \;'
      cron: "0 23 * * *"
      forget: prune
  backends:
    backblaze:
      type: b2
      # Name of the B2 bucket
      path: dabpaperless
      # Key used by restic to encrypt backups
      key: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        32333134326635633035336666626532353662623831373438643831643463643964396339386434
        3863356266643530313936363431363165303533643830610a373164386338393030343430396532
        33343865666137633835303163633536323162646533336531373039616539326536343965653134
        3335353463626134330a303064386461616262626336643532653232616437376634386134666634
        64383737333236613631613233623836303061306530366430306531656131383662
      # Backblaze B2 application ID and key
      env:
        B2_ACCOUNT_ID: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65336264653862633866366561626563616635373033653235313739303834656236393639373236
          3034313634613166323338396565326362666638663963380a373365653861656637346539626462
          33633265363031326361353638363561376536323061656638616333646133346639343862303761
          3730633030333463390a643336666537303531363034356234383930303831383062633462366632
          31323465373637613366386535366139366566336361343861336432376539643438
        B2_ACCOUNT_KEY: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          39623239383130353437623063343434656432373763613666636161326435313339346539373233
          3435333539333565303462376134623864393062346266390a633135626439313666376461363733
          61343062663732643765623064393066636636356230616666623235363732363437643539626239
          3365396463336138640a653533653938363136326536643161353437666535333633386632643631
          65343935643839323133633633393236346231353166633234643139373831346131
autorestic_cron: true
autorestic_cron_verbose: true
