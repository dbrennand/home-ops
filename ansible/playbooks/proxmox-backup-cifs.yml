---
- name: Proxmox Backup Server | Mount CIFS Share
  hosts: backup01.net.dbren.uk
  become: true
  handlers:
    - name: daemon-reload
      ansible.builtin.systemd:
        daemon_reload: true
  vars:
    cifs_share: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          64306232323431663565663534353038313739643962366638383639306439643330646163663133
          3535383035353530386164613538326362626137356331660a336464626630613530396532653935
          36366132326635616663383137303066306336666630626135386632343965353930356165393866
          3766313131323334320a613532623539663764343430376335313738633532663231633433626266
          66653833656138613934643137346133383533316435333337333232393632303134373734383364
          3064336164363532353336373333313038326665303833623235
    mountpoint: /mnt/storagebox
    smb_username: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31393636316131333463616664666661363130396236363037376336376537633834613733326236
          3061643266323030663936393533313233303332633238310a633537366135666363316434663038
          34633234643531633232373364623037656563353630343463646261343238313961313336313236
          3632363262643762390a393037643535366132666435363532393861653533633462633438383565
          3938
    smb_password: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          65393031336235393362383266643133636337376465333635333132316535373738626536623031
          3137396635663665613830313937383535663438363635650a333334666362313866313434623666
          32356130363266663165643637356532666363303565373638363166373736623535346533303835
          3530353738386436620a323562626534396335323934383839663230323163663163346263323530
          61343833383463313839623361366363636134343031613963616265346533396430
  tasks:
    - name: Create Samba credentials file
      ansible.builtin.copy:
        content: |
          username={{ smb_username }}
          password={{ smb_password }}
        dest: /etc/samba/.smbcreds
        mode: "0600"
        state: present

    - name: Mount CIFS Share
      notify: daemon-reload
      ansible.posix.mount:
        src: "{{ cifs_share }}"
        path: "{{ mountpoint }}"
        # backup user uid is 34 and gid is 34
        opts: vers=3.0,credentials=/etc/samba/.smbcreds,uid=34,gid=34,defaults
        fstype: cifs
        state: present
